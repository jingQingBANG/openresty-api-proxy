# OpenResty API Proxy 测试报告

**测试时间**: 2026-01-18 01:48:16
**测试目标**: http://localhost:8080

## 测试结果

| 项目 | 数量 |
|------|------|
| ✓ 通过 | 29 |
| ✗ 失败 | 0 |
| ⊘ 跳过 | 0 |
| **总计** | 29 |
| **通过率** | 100% |

## 限流与熔断测试

### 设计原理

```
请求流程: 请求进入 → 限流检查(429) → 熔断检查(503) → 代理上游

保护层级:
┌─────────────────────────────────────┐
│           请求流量                   │
└─────────────────┬───────────────────┘
                  │
        ┌─────────▼─────────┐
        │    限流检查        │  ← 第一道防线 (保护本地资源)
        │  超过阈值返回 429  │     基于请求速率
        └─────────┬─────────┘
                  │ 通过
        ┌─────────▼─────────┐
        │    熔断检查        │  ← 第二道防线 (保护上游服务)
        │  打开时返回 503    │     基于错误累计
        └─────────┬─────────┘
                  │ 通过
        ┌─────────▼─────────┐
        │    代理到上游      │
        └───────────────────┘
```

### 测试方法

| 测试类型 | 方法 | 目的 |
|----------|------|------|
| 限流测试 | 并发请求 | 瞬时高 QPS 触发限流 |
| 熔断测试 | 串行请求 | 累计上游错误触发熔断 |
| 综合测试 | 混合请求 | 验证执行顺序 |

### 配置参数

| 参数 | 值 | 说明 |
|------|-----|------|
| rate | 10 QPS | 每秒允许10个请求 |
| burst | 5 | 允许突发5个请求 |
| max_errors | 5 | 5次错误触发熔断 |
| reset_timeout | 30s | 熔断后30秒尝试恢复 |

## 详细日志

```

═══════════════════════════════════════════════════════════
  OpenResty API Proxy 功能测试
═══════════════════════════════════════════════════════════
目标: http://localhost:8080
时间: 2026-01-18 01:47:23

--- 检查服务状态 ---
✓ 服务运行中

--- 1. 基础端点测试 ---
✓ PASS (HTTP 200, 19ms)
✓ PASS (HTTP 200, 14ms)
✓ PASS (HTTP 200, 19ms)

--- 2. 监控端点测试 ---
✓ PASS (HTTP 200, 14ms)
✓ PASS (HTTP 200, 58ms)

--- 3. 熔断器端点测试 ---
✓ PASS (HTTP 200, 12ms)
✓ PASS (HTTP 200, 13ms)

--- 4. 降级功能测试 ---
✓ PASS (HTTP 503, 13ms)
✓ PASS (HTTP 503, 11ms)
✓ PASS (HTTP 503, 12ms)

--- 5. 熔断器操作测试 ---
✓ PASS (HTTP 200, 15ms)
✓ PASS
✓ PASS (HTTP 200, 14ms)
✓ PASS

--- 6. 限流功能测试 (并发请求) ---
  【原理】限流基于请求速率，并发请求更容易触发
  【配置】rate=10 QPS, burst=5

✓ 已重置
✓ PASS (限流已触发)
    统计: 200(成功)=0, 429(限流)=23, 503(熔断)=6, 504(超时)=0, 其他=1

--- 7. 熔断器功能测试 (串行请求) ---
  【原理】熔断基于错误累计，串行请求更容易触发
  【配置】max_errors=5, reset_timeout=30s

✓ 已重置
✓ PASS
✓ PASS (熔断已触发)
    统计: 200(成功)=0, 503(熔断)=10, 其他=0
✓ "state":"CLOSED"

--- 8. 综合测试 - 先限流后熔断 ---
  【设计】请求进入 → 限流检查(429) → 熔断检查(503) → 代理上游

✓ 已重置

  阶段1: 并发请求 (测试限流优先)
429(限流)=14, 2xx/3xx/4xx=1, 503(熔断)=5

  阶段2: 串行请求 (测试熔断触发)
503(熔断)=10, 其他=0

  阶段3: 验证执行顺序
✓ PASS (429在第1个, 503在第10个 - 限流先于熔断)

--- 9. Prometheus 指标验证 ---
✓ PASS
✓ PASS
✓ PASS
✓ PASS
✓ PASS
✓ PASS
✓ PASS

--- 10. JSON 指标格式验证 ---
✓ PASS
✓ PASS
✓ PASS
✓ PASS

--- 11. 压力测试 (ab) ---
  健康检查端点压测 (100请求, 10并发):

  代理端点压测 (50请求, 5并发):

═══════════════════════════════════════════════════════════
  测试结果汇总
═══════════════════════════════════════════════════════════

  ✓ 通过: 29
  ✗ 失败: 0
  ⊘ 跳过: 0
  ─────────────
  总计: 29
  通过率: 100%


--- 指标摘要 ---
  总请求数:     465
  成功请求:     16
  错误请求:     449
  限流拦截:     0
  熔断拦截:     337

生成测试报告: docs/ab_test/test_report_20260118_014723.md
```

## Prometheus 指标快照

```prometheus
# HELP nginx_metric_errors_total Number of nginx-lua-prometheus errors
# TYPE nginx_metric_errors_total counter
nginx_metric_errors_total 0
# HELP proxy_circuit_breaker_failures Current failure count in circuit breaker
# TYPE proxy_circuit_breaker_failures gauge
proxy_circuit_breaker_failures{provider="alchemy"} 0
proxy_circuit_breaker_failures{provider="coingecko"} 0
proxy_circuit_breaker_failures{provider="zerion"} 0
# HELP proxy_circuit_breaker_rejected_total Total number of requests rejected by circuit breaker
# TYPE proxy_circuit_breaker_rejected_total counter
proxy_circuit_breaker_rejected_total{provider="alchemy"} 0
proxy_circuit_breaker_rejected_total{provider="coingecko"} 317
proxy_circuit_breaker_rejected_total{provider="zerion"} 20
# HELP proxy_circuit_breaker_state Circuit breaker state (0=CLOSED, 1=HALF_OPEN, 2=OPEN)
# TYPE proxy_circuit_breaker_state gauge
proxy_circuit_breaker_state{provider="alchemy"} 0
proxy_circuit_breaker_state{provider="coingecko"} 0
proxy_circuit_breaker_state{provider="zerion"} 0
# HELP proxy_connections Current number of connections
# TYPE proxy_connections gauge
proxy_connections{state="active"} 1
proxy_connections{state="reading"} 0
proxy_connections{state="waiting"} 0
proxy_connections{state="writing"} 1
# HELP proxy_fallback_triggered_total Total number of fallback responses
# TYPE proxy_fallback_triggered_total counter
proxy_fallback_triggered_total{provider="coingecko",original_status="503"} 5
proxy_fallback_triggered_total{provider="coingecko",original_status="504"} 62
proxy_fallback_triggered_total{provider="test",original_status="502"} 5
proxy_fallback_triggered_total{provider="zerion",original_status="504"} 4
# HELP proxy_provider_health Provider health status (1=healthy, 0=unhealthy)
# TYPE proxy_provider_health gauge
proxy_provider_health{provider="alchemy",state="CLOSED"} 1
proxy_provider_health{provider="coingecko",state="CLOSED"} 1
proxy_provider_health{provider="zerion",state="CLOSED"} 1
# HELP proxy_rate_limited_total Total number of rate limited requests
# TYPE proxy_rate_limited_total counter
proxy_rate_limited_total{provider="alchemy"} 0
proxy_rate_limited_total{provider="coingecko"} 0
proxy_rate_limited_total{provider="zerion"} 0
# HELP proxy_request_duration_seconds Request duration in seconds
# TYPE proxy_request_duration_seconds histogram
proxy_request_duration_seconds_bucket{provider="coingecko",le="0.01"} 66
proxy_request_duration_seconds_bucket{provider="coingecko",le="0.025"} 68
proxy_request_duration_seconds_bucket{provider="coingecko",le="0.05"} 70
proxy_request_duration_seconds_bucket{provider="coingecko",le="0.1"} 212
proxy_request_duration_seconds_bucket{provider="coingecko",le="0.25"} 222
proxy_request_duration_seconds_bucket{provider="coingecko",le="0.5"} 368
proxy_request_duration_seconds_bucket{provider="coingecko",le="1"} 399
proxy_request_duration_seconds_bucket{provider="coingecko",le="2.5"} 407
proxy_request_duration_seconds_bucket{provider="coingecko",le="5"} 407
proxy_request_duration_seconds_bucket{provider="coingecko",le="10"} 407
proxy_request_duration_seconds_bucket{provider="coingecko",le="+Inf"} 407
proxy_request_duration_seconds_bucket{provider="zerion",le="0.01"} 40
proxy_request_duration_seconds_bucket{provider="zerion",le="0.025"} 40
proxy_request_duration_seconds_bucket{provider="zerion",le="0.05"} 40
proxy_request_duration_seconds_bucket{provider="zerion",le="0.1"} 49
proxy_request_duration_seconds_bucket{provider="zerion",le="0.25"} 53
proxy_request_duration_seconds_bucket{provider="zerion",le="0.5"} 59
proxy_request_duration_seconds_bucket{provider="zerion",le="1"} 61
proxy_request_duration_seconds_bucket{provider="zerion",le="2.5"} 61
proxy_request_duration_seconds_bucket{provider="zerion",le="5"} 61
proxy_request_duration_seconds_bucket{provider="zerion",le="10"} 61
proxy_request_duration_seconds_bucket{provider="zerion",le="+Inf"} 61
proxy_request_duration_seconds_count{provider="coingecko"} 407
proxy_request_duration_seconds_count{provider="zerion"} 61
proxy_request_duration_seconds_sum{provider="coingecko"} 114.628
proxy_request_duration_seconds_sum{provider="zerion"} 5.386
# HELP proxy_requests_errors_total Total number of failed requests
# TYPE proxy_requests_errors_total counter
proxy_requests_errors_total{provider="alchemy",error_type="circuit_breaker"} 0
proxy_requests_errors_total{provider="alchemy",error_type="client_4xx"} 0
proxy_requests_errors_total{provider="alchemy",error_type="connect_failed"} 0
proxy_requests_errors_total{provider="alchemy",error_type="rate_limited"} 0
proxy_requests_errors_total{provider="alchemy",error_type="timeout"} 0
proxy_requests_errors_total{provider="alchemy",error_type="upstream_5xx"} 0
proxy_requests_errors_total{provider="coingecko",error_type="circuit_breaker"} 317
proxy_requests_errors_total{provider="coingecko",error_type="client_4xx"} 8
proxy_requests_errors_total{provider="coingecko",error_type="connect_failed"} 0
proxy_requests_errors_total{provider="coingecko",error_type="rate_limited"} 63
proxy_requests_errors_total{provider="coingecko",error_type="timeout"} 0
proxy_requests_errors_total{provider="coingecko",error_type="upstream_5xx"} 0
proxy_requests_errors_total{provider="zerion",error_type="circuit_breaker"} 20
proxy_requests_errors_total{provider="zerion",error_type="client_4xx"} 2
proxy_requests_errors_total{provider="zerion",error_type="connect_failed"} 0
proxy_requests_errors_total{provider="zerion",error_type="rate_limited"} 39
proxy_requests_errors_total{provider="zerion",error_type="timeout"} 0
proxy_requests_errors_total{provider="zerion",error_type="upstream_5xx"} 0
# HELP proxy_requests_success_total Total number of successful requests
# TYPE proxy_requests_success_total counter
proxy_requests_success_total{provider="alchemy"} 0
proxy_requests_success_total{provider="coingecko"} 19
proxy_requests_success_total{provider="zerion"} 0
# HELP proxy_requests_total Total number of HTTP requests
# TYPE proxy_requests_total counter
proxy_requests_total{provider="coingecko",method="GET",status="200"} 19
proxy_requests_total{provider="coingecko",method="GET",status="429"} 63
proxy_requests_total{provider="coingecko",method="GET",status="499"} 8
proxy_requests_total{provider="coingecko",method="GET",status="503"} 317
proxy_requests_total{provider="zerion",method="GET",status="404"} 2
```

## JSON 指标快照

```json
{
    "timestamp": 1768672096,
    "uptime_seconds": 1485.5969998837,
    "global": {
        "note": "Use /metrics endpoint for detailed Prometheus metrics"
    },
    "connections": {
        "reading": 0,
        "writing": 1,
        "waiting": 0,
        "active": 1
    },
    "providers": {
        "zerion": {
            "health": {
                "state": "CLOSED",
                "healthy": true,
                "failure_count": 0
            }
        },
        "coingecko": {
            "health": {
                "state": "CLOSED",
                "healthy": true,
                "failure_count": 0
            }
        },
        "alchemy": {
            "health": {
                "state": "CLOSED",
                "healthy": true,
                "failure_count": 0
            }
        }
    }
}
```
